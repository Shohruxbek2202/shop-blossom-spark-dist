import{u as e,f as s,r as a,j as r}from"./vendor-react-Di3sF8BB.js";import{c as n}from"./vendor-query-B031p5Or.js";import{u as i,t,o,s as l}from"./vendor-forms-Bb9WWAsU.js";import{l as c,j as m,L as d,B as u,C as h,o as x,p as j,n as p,I as f,i as b,k as g,s as y}from"./index-DztaS-sJ.js";import{P as v}from"./phone-input-DWlDfH25.js";import{F as N,a as w,b as k,c as q,d as P,e as S}from"./form-C2npjKE3.js";import{c as B,L as I}from"./vendor-icons-UB6tg7n9.js";import"./vendor-radix-AkGGdVjm.js";import"./vendor-utils-BNexaxpF.js";import"./vendor-supabase-CKi7xGwz.js";import"./label-CY7WyAhe.js";const L=o({name:l().min(2,"Ism kamida 2 ta belgidan iborat bo'lishi kerak"),phone:l().min(9,"Telefon raqami noto'g'ri").regex(/^[\d\s\+\-\(\)]+$/,"Telefon raqamida faqat raqamlar bo'lishi kerak").refine(e=>{const s=e.replace(/\D/g,"");return s.length>=9&&s.length<=12},"Telefon raqami 9-12 ta raqamdan iborat bo'lishi kerak")}),z=()=>{const{t:o}=e(),l=s(),{items:z,totalPrice:E,clearCart:C}=c(),[T,F]=a.useState(!1),[D,$]=a.useState(!1),A=i({resolver:t(L),defaultValues:{name:"",phone:""}}),M=n({mutationFn:async e=>{if(D)throw new Error("Buyurtma allaqachon yuborilmoqda");$(!0);const s=z.filter(e=>!e.streamLink||""===e.streamLink.trim());if(s.length>0){const e=s.map(e=>e.name).join(", ");throw new Error(`Bu mahsulotlarga stream_link qo'shilmagan: ${e}. Iltimos, admin paneldan qo'shing.`)}const a=z.map(async s=>{const{data:a,error:r}=await y.functions.invoke("process-order",{body:{productId:s.id,customerName:e.name||"Xaridor",customerPhone:e.phone,productName:s.name,streamLink:s.streamLink||"",quantity:s.quantity,totalPrice:(s.salePrice||s.price)*s.quantity}});if(r)throw new Error(r.message||"Buyurtma yuborishda xatolik");if(a&&!a.success)throw new Error(a.error||"Buyurtma yuborishda xatolik");return a&&!a.apiSuccess&&a.apiError,a});return Promise.all(a)},onSuccess:()=>{g({orderId:"order-"+Date.now(),value:E,contentIds:z.map(e=>e.id),numItems:z.reduce((e,s)=>e+s.quantity,0)}),F(!0),C(),b.success(o("orderPlaced"))},onError:e=>{$(!1);const s=e instanceof Error?e.message:"Buyurtma yuborishda xatolik yuz berdi";b.error(s)}});return a.useState(()=>{z.length>0&&m({ids:z.map(e=>e.id),value:E,numItems:z.reduce((e,s)=>e+s.quantity,0)})}),0!==z.length||T?T?r.jsx(d,{children:r.jsxs("div",{className:"container py-16 text-center max-w-md",children:[r.jsx("div",{className:"w-20 h-20 rounded-full bg-success/20 flex items-center justify-center mx-auto mb-6",children:r.jsx(B,{className:"h-10 w-10 text-success"})}),r.jsx("h1",{className:"text-2xl font-serif font-bold mb-2",children:o("orderPlaced")}),r.jsx("p",{className:"text-muted-foreground mb-6",children:"Tez orada operatorlarimiz siz bilan boglanishadi"}),r.jsx(u,{onClick:()=>l("/"),children:o("home")})]})}):r.jsx(d,{children:r.jsxs("div",{className:"container py-8 max-w-2xl",children:[r.jsx("h1",{className:"text-3xl font-serif font-bold mb-8",children:o("checkout")}),r.jsxs("div",{className:"grid gap-8",children:[r.jsxs(h,{children:[r.jsx(x,{children:r.jsx(j,{children:"Buyurtma tafsilotlari"})}),r.jsx(p,{children:r.jsxs("div",{className:"space-y-4",children:[z.map(e=>r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsx("div",{className:"w-16 h-16 rounded-md overflow-hidden bg-secondary",children:r.jsx("img",{src:e.image,alt:e.name,className:"w-full h-full object-cover"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("h4",{className:"font-medium",children:e.name}),r.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.quantity," x ",(e.salePrice||e.price).toLocaleString()," som"]})]}),r.jsxs("span",{className:"font-bold",children:[((e.salePrice||e.price)*e.quantity).toLocaleString()," som"]})]},e.id)),r.jsxs("div",{className:"border-t pt-4 flex justify-between text-lg font-bold",children:[r.jsx("span",{children:o("total")}),r.jsxs("span",{className:"text-primary",children:[E.toLocaleString()," som"]})]})]})})]}),r.jsxs(h,{children:[r.jsx(x,{children:r.jsx(j,{children:"Mijoz malumotlari"})}),r.jsx(p,{children:r.jsx(N,{...A,children:r.jsxs("form",{onSubmit:A.handleSubmit(e=>M.mutate(e)),className:"space-y-4",children:[r.jsx(w,{control:A.control,name:"name",render:({field:e})=>r.jsxs(k,{children:[r.jsx(q,{children:o("name")}),r.jsx(P,{children:r.jsx(f,{placeholder:"Ismingiz",...e})}),r.jsx(S,{})]})}),r.jsx(w,{control:A.control,name:"phone",render:({field:e})=>r.jsxs(k,{children:[r.jsx(q,{children:o("phone")}),r.jsx(P,{children:r.jsx(v,{value:e.value,onChange:e.onChange})}),r.jsx(S,{})]})}),r.jsx(u,{type:"submit",className:"w-full",size:"lg",disabled:M.isPending||D,children:M.isPending||D?r.jsxs(r.Fragment,{children:[r.jsx(I,{className:"h-4 w-4 mr-2 animate-spin"}),"Yuborilmoqda..."]}):"Buyurtma berish"})]})})})]})]})]})}):(l("/cart"),null)};export{z as default};
